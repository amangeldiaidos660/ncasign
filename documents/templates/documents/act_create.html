{% extends 'documents/base_documents.html' %}
{% block documents_title %}Создание акта - ncasign{% endblock %}
{% block extra_css %}
{{ block.super }}
<style>
    .editor-container {
        display: flex;
        gap: 2rem;
        height: calc(100vh - 200px);
    }
    .form-section {
        flex: 0 0 400px;
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        overflow-y: auto;
    }
    .preview-section {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        overflow-y: auto;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }
    .preview-placeholder {
        text-align: center;
        color: #666;
        padding: 3rem;
        border: 2px dashed #ddd;
        border-radius: 10px;
    }
    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        color: white;
    }
    .btn-download {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 1rem;
    }
    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        color: white;
    }
    .form-control {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 14px;
    }
</style>
{% endblock %}
{% block extra_js %}
<script src="/static/js/loader.js"></script>
{% endblock %}
{% block documents_content %}
<div class="editor-container">
    <!-- Форма для заполнения акта -->
    <div class="form-section">
        <h4 class="mb-4">Заполнение акта</h4>
        
        <form id="actForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.executor.id_for_label }}" class="form-label">{{ form.executor.label }}</label>
                {{ form.executor }}
            </div>
            <div class="form-group">
                <label for="{{ form.full_name.id_for_label }}" class="form-label">{{ form.full_name.label }}</label>
                {{ form.full_name }}
            </div>
            <div class="form-group">
                <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }}</label>
                {{ form.phone_number }}
            </div>
            <div class="form-group">
                <label for="{{ form.iin.id_for_label }}" class="form-label">{{ form.iin.label }}</label>
                {{ form.iin }}
            </div>
            <div class="form-group">
                <label for="{{ form.text.id_for_label }}" class="form-label">{{ form.text.label }}</label>
                {{ form.text }}
            </div>
            <div class="form-group">
                <label for="{{ form.unit.id_for_label }}" class="form-label">{{ form.unit.label }}</label>
                {{ form.unit }}
            </div>
            <div class="form-group">
                <label for="{{ form.additional_text.id_for_label }}" class="form-label">{{ form.additional_text.label }}</label>
                {{ form.additional_text }}
            </div>
            <div class="form-group">
                <label for="{{ form.start_date.id_for_label }}" class="form-label">{{ form.start_date.label }}</label>
                {{ form.start_date }}
            </div>
            <div class="form-group">
                <label for="{{ form.end_date.id_for_label }}" class="form-label">{{ form.end_date.label }}</label>
                {{ form.end_date }}
            </div>
            <div class="form-group d-flex align-items-center">
                <label for="{{ form.unit_price.id_for_label }}" class="form-label me-2">{{ form.unit_price.label }}</label>
                {{ form.unit_price }}
                <div class="form-check ms-3">
                    {{ form.vat_included }}
                    <label class="form-check-label" for="{{ form.vat_included.id_for_label }}">{{ form.vat_included.label }}</label>
                </div>
            </div>
            <div class="form-group">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}</label>
                {{ form.quantity }}
            </div>
            <div class="form-group">
                <label class="form-label">Согласующие</label>
                <div id="approvers-list"></div>
                <button type="button" class="btn btn-outline-primary btn-sm mb-2" id="add-approver-btn">
                    <i class="fas fa-plus me-1"></i>Добавить согласующего
                </button>
                {{ form.approvers }}
            </div>
            <div class="form-group" id="signer-block">
                <label for="signer" class="form-label">Подписант</label>
                {{ form.signer }}
            </div>
            <!-- Кнопки действий -->
            <div class="form-group">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-download flex-fill" id="saveAct">
                        <i class="fas fa-save me-2"></i>Сохранить акт
                    </button>
                    <button type="button" class="btn btn-primary flex-fill" id="addToPackage">
                        <i class="fas fa-plus me-2"></i>Добавить в пакет
                    </button>
                </div>
                <button type="button" class="btn btn-success w-100 mt-2" id="savePackage" style="display: none;">
                    <i class="fas fa-box me-2"></i>Сохранить пакет
                </button>
            </div>
            
            <!-- Информация о пакете -->
            <div class="form-group" id="package-info" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-box me-2"></i>
                    <strong>Пакет актов:</strong> <span id="package-count">0</span> актов
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="clearPackage">
                        <i class="fas fa-trash me-1"></i>Очистить пакет
                    </button>
                </div>
            </div>
            
        </form>
    </div>
    
    <!-- Предпросмотр шаблона акта -->
    <div class="preview-section">
        <div id="preview-content">
            <div class="preview-placeholder">
                <i class="fas fa-file-word fa-3x mb-3 text-muted"></i>
                <p>Загрузка шаблона акта...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Данные пользователей из Django
const usersData = JSON.parse('{{ users_data_json|escapejs }}');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, инициализируем элементы...');
    const form = document.getElementById('actForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    const previewContent = document.getElementById('preview-content');
    const executorSelect = document.getElementById('executor-select');
    const fullNameInput = document.getElementById('full-name-input');
    const phoneInput = document.getElementById('phone-input');
    const iinInput = document.getElementById('iin-input');
    
    // Проверяем наличие элементов пакета
    const packageElements = {
        packageInfo: document.getElementById('package-info'),
        packageCount: document.getElementById('package-count'),
        saveAct: document.getElementById('saveAct'),
        addToPackage: document.getElementById('addToPackage'),
        savePackage: document.getElementById('savePackage'),
        clearPackage: document.getElementById('clearPackage')
    };
    
    console.log('Проверка элементов пакета:', packageElements);

    const quantityInput = document.getElementById('quantity-input');
    const unitPriceInput = document.getElementById('unit-price-input');
    
    // --- Согласующие ---
    const approversSelect = document.getElementById('id_approvers');
    const approversListDiv = document.getElementById('approvers-list');
    const addApproverBtn = document.getElementById('add-approver-btn');
    // Получаем список всех согласующих из select
    let allApprovers = [];
    if (approversSelect) {
        allApprovers = Array.from(approversSelect.options).map(opt => ({
            username: opt.value,
            full_name: opt.text
        }));
        // Скрываем сам select
    approversSelect.style.display = 'none';
    }
    let selectedApprovers = [];
    function renderApproversList() {
        approversListDiv.innerHTML = '';
        selectedApprovers.forEach((appr, idx) => {
            const el = document.createElement('div');
            el.className = 'd-flex align-items-center mb-1';
            el.innerHTML = `<span class="me-2">${appr.full_name} <span class='text-muted'>(${appr.username})</span></span>` +
                `<button type='button' class='btn btn-sm btn-danger ms-2' data-idx='${idx}'>Удалить</button>`;
            approversListDiv.appendChild(el);
        });
        // Синхронизируем select
        if (approversSelect) {
        Array.from(approversSelect.options).forEach(opt => {
                opt.selected = selectedApprovers.some(appr => appr.username === opt.value);
            });
        }
        updatePreview();
    }
    if (addApproverBtn) {
        addApproverBtn.addEventListener('click', function() {
            // Показываем выпадающий список для выбора
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm d-inline-block w-auto me-2';
            select.innerHTML = '<option value="">Выберите согласующего</option>' +
                allApprovers
                    .filter(appr => !selectedApprovers.some(sel => sel.username === appr.username))
                    .map(appr => `<option value="${appr.username}">${appr.full_name} (${appr.username})</option>`)
                    .join('');
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-success btn-sm';
            addBtn.textContent = 'Добавить';
            addBtn.onclick = function() {
                const val = select.value;
                if (val && !selectedApprovers.some(appr => appr.username === val)) {
                    const found = allApprovers.find(appr => appr.username === val);
                    if (found) {
                        selectedApprovers.push(found);
                        renderApproversList();
                        select.remove();
                        addBtn.remove();
                    }
                }
            };
            approversListDiv.appendChild(select);
            approversListDiv.appendChild(addBtn);
        });
    }
    approversListDiv.addEventListener('click', function(e) {
        if (e.target.matches('button[data-idx]')) {
            const idx = parseInt(e.target.getAttribute('data-idx'));
            selectedApprovers.splice(idx, 1);
            renderApproversList();
        }
    });
    // При отправке формы синхронизируем select
    form.addEventListener('submit', function() {
        if (approversSelect) {
            Array.from(approversSelect.options).forEach(opt => {
                opt.selected = selectedApprovers.some(appr => appr.username === opt.value);
            });
        }
        // Для подписанта ничего не нужно, select всегда один, просто выбранный option
    });
    // При загрузке страницы
    renderApproversList();
    
    // Автоматическое заполнение данных при выборе исполнителя
    if (executorSelect) {
        executorSelect.addEventListener('change', function() {
            const selectedUsername = this.value;
            if (selectedUsername && usersData[selectedUsername]) {
                const userData = usersData[selectedUsername];
                fullNameInput.value = userData.full_name || '';
                phoneInput.value = userData.phone_number || '';
                iinInput.value = userData.iin || '';
                
                // ID договора будет заполнен автоматически при предпросмотре
            } else {
                // Очищаем поля если пользователь не выбран или данных нет
                fullNameInput.value = '';
                phoneInput.value = '';
                iinInput.value = '';
            }
            // Запускаем обновление предпросмотра
            updatePreview();
        });
    }
    

    
    // Функция для обновления предпросмотра
    function updatePreview() {
        const formData = new FormData(form);
        
        fetch('{% url "documents:act_preview" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                previewContent.innerHTML = data.preview_html;
            } else {
                console.error('Ошибка обновления предпросмотра:', data.error);
                previewContent.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
            previewContent.innerHTML = `<div class="alert alert-danger">Ошибка сети: ${error.message}</div>`;
        });
    }
    
    // Обновляем предпросмотр при изменении любого поля
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            updatePreview();
        });
        
        input.addEventListener('change', function() {
            updatePreview();
        });
        
        input.addEventListener('blur', function() {
            updatePreview();
        });
    });
    
    // Автоматический расчет общей стоимости при изменении количества или цены за единицу
    function calculateTotalAmount() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        
        if (quantity > 0 && unitPrice > 0) {
            const totalAmount = quantity * unitPrice;
            // Стоимость рассчитывается автоматически в предпросмотре
        }
    }
    
    // Специальная обработка для полей количества и цены за единицу
    if (quantityInput && unitPriceInput) {
        quantityInput.addEventListener('input', function() {
            calculateTotalAmount();
            updatePreview();
        });
        
        unitPriceInput.addEventListener('input', function() {
            calculateTotalAmount();
            updatePreview();
        });
    }
    
    // Загружаем начальный предпросмотр
    function loadInitialPreview() {
        fetch('{% url "documents:act_preview" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                previewContent.innerHTML = data.preview_html;
            } else {
                previewContent.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            previewContent.innerHTML = `<div class="alert alert-danger">Ошибка сети: ${error.message}</div>`;
        });
    }

    // Загружаем начальный предпросмотр
    loadInitialPreview();
    
    // --- Функции для работы с пакетами ---
    // Удаляем старую логику, связанную с package-count, updateSignerBlockVisibility и т.д.

    // --- Новая логика отображения поля подписанта ---
    function updateSignerBlockFromServer() {
        fetch('/documents/acts/package-count/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const signerBlock = document.getElementById('signer-block');
            if (signerBlock) {
                if (data.success && data.count > 0) {
                    signerBlock.style.display = 'none';
                } else {
                    signerBlock.style.display = '';
                }
            }
        })
        .catch(error => {
            console.error('Ошибка получения количества актов в пакете:', error);
        });
    }
    // Вызываем при загрузке страницы
    updateSignerBlockFromServer();

    // ВОССТАНАВЛИВАЮ обработчик кнопки "Добавить в пакет"
    const addToPackageBtn = document.getElementById('addToPackage');
    if (addToPackageBtn) {
        addToPackageBtn.addEventListener('click', function() {
            const formData = new FormData(document.getElementById('actForm'));
            
            showLoader();
            fetch('/documents/acts/add-to-package/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoader();
                if (data.success) {
                    alert(data.message);
                    // Очищаем форму для следующего акта
                    document.getElementById('actForm').reset();
                    selectedApprovers = [];
                    renderApproversList();
                    loadInitialPreview();
                    updateSignerBlockFromServer(); // Скрываем поле подписанта после добавления в пакет
                    updatePackageUI(data.package_count); // Обновляем UI пакета
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoader();
                console.error('Ошибка запроса:', error);
                alert('Ошибка сети при добавлении в пакет');
            });
        });
    }

    // ВОССТАНАВЛИВАЮ логику работы с пакетом
    function updatePackageUI(packageCount) {
        const packageInfo = document.getElementById('package-info');
        const packageCountSpan = document.getElementById('package-count');
        const savePackageBtn = document.getElementById('savePackage');
        
        if (packageCount > 0) {
            packageInfo.style.display = 'block';
            packageCountSpan.textContent = packageCount;
            savePackageBtn.style.display = 'inline-block';
        } else {
            packageInfo.style.display = 'none';
            savePackageBtn.style.display = 'none';
        }
    }

    // ВОССТАНАВЛИВАЮ обработчик кнопки "Сохранить пакет"
    const savePackageBtn = document.getElementById('savePackage');
    if (savePackageBtn) {
        savePackageBtn.addEventListener('click', function() {
            if (!confirm('Сохранить пакет актов? Это действие нельзя отменить.')) {
                return;
            }
            
            showLoader();
            fetch('/documents/acts/save-package/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoader();
                if (data.success) {
                    alert(data.message);
                    updatePackageUI(0);
                    updateSignerBlockFromServer();
                    window.location.href = '{% url "documents:act_list" %}';
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoader();
                console.error('Ошибка запроса:', error);
                alert('Ошибка сети при сохранении пакета');
            });
        });
    }

    // ВОССТАНАВЛИВАЮ обработчик кнопки "Очистить пакет"
    const clearPackageBtn = document.getElementById('clearPackage');
    if (clearPackageBtn) {
        clearPackageBtn.addEventListener('click', function() {
            if (!confirm('Очистить пакет? Все добавленные акты будут удалены.')) {
                return;
            }
            
            showLoader();
            fetch('/documents/acts/clear-package/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoader();
                if (data.success) {
                    alert(data.message);
                    updatePackageUI(0);
                    updateSignerBlockFromServer();
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoader();
                console.error('Ошибка запроса:', error);
                alert('Ошибка сети при очистке пакета');
            });
        });
    }

    // ВОССТАНАВЛИВАЮ обработчик кнопки "Сохранить акт"
    const saveActBtn = document.getElementById('saveAct');
    if (saveActBtn) {
        saveActBtn.addEventListener('click', function() {
            const formData = new FormData(document.getElementById('actForm'));
            showLoader();
            fetch('{% url "documents:act_save" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoader();
                if (data.success) {
                    alert(`Акт успешно сохранен! ID: ${data.act_id}`);
                    window.location.href = '{% url "documents:act_list" %}';
                } else {
                    alert(`Ошибка сохранения: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoader();
                console.error('Ошибка запроса:', error);
                alert('Ошибка сети при сохранении');
            });
        });
    }

    const signerBlock = document.getElementById('signer-block');
    if (signerBlock && addToPackageBtn && saveActBtn) {
        addToPackageBtn.addEventListener('click', function() {
            signerBlock.style.display = 'none';
        });
        saveActBtn.addEventListener('click', function() {
            signerBlock.style.display = '';
        });
    }
});
</script>
{% endblock %} 